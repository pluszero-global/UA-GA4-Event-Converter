___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "UA to GA4 Event Converter",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "From UA to GA4 Event Converter.\n\nThis template automatically converts UA custom events into GA4 custom events.\n\nDon\u0027t forget to register Action, Label, and Value.\n\nContact: pluszero@pluszero.co.kr",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "measurementId",
    "displayName": "GA4 Measurement ID",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "Category",
    "displayName": "Category",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "Action",
    "displayName": "Action",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "Label",
    "displayName": "Label",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "Value",
    "displayName": "Value",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NUMBER"
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "custom_dimensions",
    "displayName": "Custom dimensions",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Index",
        "name": "index",
        "type": "TEXT",
        "selectItems": []
      },
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "value",
        "type": "TEXT",
        "selectItems": []
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "user_properties",
    "displayName": "User Properties",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Key",
        "name": "key",
        "type": "TEXT",
        "selectItems": []
      },
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "value",
        "type": "TEXT",
        "selectItems": []
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const makeTableMap = require('makeTableMap');
const query = require('queryPermission');
const createQueue = require('createQueue');
const dataLayerPush = createQueue('dataLayer');
const createArgumentsQueue = require('createArgumentsQueue');
const copyFromWindow = require('copyFromWindow');
const setInWindow = require('setInWindow');
const injectScript = require('injectScript');
const getTimestampMillis = require('getTimestampMillis');

const measurementId = data.measurementId;
const category = data.Category;
const action = data.Action;
const label = data.Label;
const value = data.Value;

let custom_dimensions = data.custom_dimensions ? makeTableMap(data.custom_dimensions, 'index', 'value') : undefined;
let user_properties = data.user_properties ? makeTableMap(data.user_properties, 'key', 'value') : undefined;

let gtag = copyFromWindow('gtag');
if(!gtag){
  gtag = createArgumentsQueue('gtag', 'dataLayer');
  injectScript('https://www.googletagmanager.com/gtag/js?id='+measurementId, data.gtmOnSuccess, data.gtmOnFailure, 'gtag');
  
  gtag('js', getTimestampMillis());
}

gtag('config', measurementId, {
    send_page_view: false
  });

if(user_properties){
  gtag('set', 'user_properties', user_properties);
}

let parameters = {};

if(action){
  parameters.action = action;
}

if(label){
  parameters.label = label;
}

if(value){
  parameters.value = value;
}


if(custom_dimensions){
  for(var key in custom_dimensions){
    parameters["dimension"+key] = custom_dimensions[key];
  }
}

parameters.send_to = measurementId;

gtag('event', category, parameters);

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtag"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://www.googletagmanager.com/gtag/js?id\u003d*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Quick Test
  code: runCode();
setup: ''


___NOTES___

Created on 2021. 1. 4. 오전 11:41:36


